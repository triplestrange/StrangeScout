version: '3.5'
services:
        jscout:
                build:
                        context: ./jscout/
                        dockerfile: Dockerfile-traefik
                restart: always
                depends_on:
                        - "strangedb"
                environment:
                        JSCOUT_DOMAIN: ${JSCOUT_DOMAIN?did not set the domain name}
                        COUCHDB_HOST: "strangedb"
                expose: # this container exports HTTP-as-a-service
                        - "80"
                networks:
                        - "traefik"
                        - "default"
                labels:
                        traefik.enable: "true"
                        traefik.docker.network: "${TRAEFIK_NETWORK?did not setup network to reach traefik on}"
                        traefik.port: "80"
                        traefik.frontend.rule: "Host:${JSCOUT_DOMAIN?did not set domain},*.$JSCOUT_DOMAIN"
                        traefik.frontend.headers.STSSeconds: "31536000"
                        traefik.frontend.headers.STSIncludeSubdomains: "true"
                        traefik.frontend.headers.STSPreload: "true"

        strangedb:
                image: treehouses/couchdb:2.2.0
                restart: always
                volumes:
                        - type: volume
                          source: strangedb
                          target: /opt/couchdb
                        - type: volume
                          source: strangedb_data
                          target: /opt/couchdb/data
                environment:
                        COUCHDB_PASSWORD: "${STRANGESCOUT_DB_PASSWD?did not set password!}"
                        COUCHDB_USER: "strangescout"
                expose:
                        - "5984"
                ports:
                        - "{$COUCHDB_PUBLIC_PORT:-5984}:5984"
                labels:
                        traefik.enable: "false"

volumes:
        strangedb:
                name: ${PREFIX-prod}_strangedb
        strangedb_data:
                name: ${PREFIX-prod}_strangedb_data
networks:
        traefik:
                external: true
                name: ${TRAEFIK_NETWORK?did not set a network to reach traefik on}
